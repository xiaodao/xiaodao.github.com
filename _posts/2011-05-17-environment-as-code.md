---
layout: post
title: 我们为什么需要“环境即代码”？
category: 敏捷开发
tags: [devops]
---
还记得十多年前，我有一天凌晨去网吧，发现所有的机箱都被拆开了，老板拿着一块硬盘一台机器一台机器的往上接。每接好一台，屏幕上就会出现一个蓝色的画面，然后会有一个长长的进度条，等它滚到尽头，老板就关机把硬盘拆下来，再接到另一台机器上重复同样的过程。我问老板说，这是什么东西啊。老板从烟圈中淡淡吐出几个“镜像”、“克隆”之类的词，顿时让我对火光明灭间的那张脸生了高山仰止之心。

直到几年后，我见到了同样的蓝色画面和滚动条，才知道当年的那款软件叫做“Ghost”。Ghost也算得上是个异数了，Windows NT隐去了，98被XP取代了，XP不提供支持了，它却是历久弥新。

公司一直也在用Ghost。有新同事加入团队，要给他一个跟其他人一样的开发环境，拿Ghost镜像还原一份就好了，分分钟的事情，方便的很。

它可以帮助团队打造一个一致的开发环境：每台机器的IDE、运行时环境、所需要的软件，乃至快捷键等，都是一模一样的。如果我们再消除脚本中对绝对路径的依赖，把所有构建相关的脚本都放入版本库，那么从版本库上check out出来的代码，在所有的机器上运行就都可以得到同样的结果。

看起来很体面了，哈？

然则在一个历时近两年，有20台开发机、10台测试机、30个Cruise Agent的项目中，这依然是不够的。

比如要所有机器都安装特定版本的windows update、.net 3.5要升级到4.0，要禁用掉所有机器上的防火墙、更改IIS的某些配置等等，等等。你是打算手工做呢，还是手工做呢，还是手工做呢？

而当环境发生过变化，Ghost镜像又没有及时更新时候，无论是加一台开发机，还是agent，都要在Ghost之后花上不少时间去手工调试环境。
经过切肤之痛后，我们发现，如果不能用编程的方式把产品代码运行所需要的环境完完整整的表述出来，并纳入版本控制系统的管理中，就始终无法达到环境的一致性和标准化。而如果做不到这一点，就会为环境的同步付出不菲的代价。

基于这样的背景，我希望这个项目可以做到：
<ul>
	<li>在版本仓库中存放代码运行环境的DSL描述，当环境需要更新时，更改描述文件，所有机器更新代码之后，运行一个命令，本地环境就可以升级。（或者是有一个地方集中存放所有机器的ip地址，SSH到每台机器上去更新代码、升级环境）。</li>
</ul>
<ul>
	<li>要有脚本来执行DSL。</li>
</ul>
<ul>
	<li>并不是所有的机器都有相同的环境配置，但同一种类型的机器的配置相同（比如开发、测试、Cruise agent），所以要能够用Role来表示一组环境。</li>
</ul>
<ul>
	<li>如果网络中加入一台新机器，它更新代码执行命令后，也可以同步到跟其他机器相同的环境。</li>
</ul>
这一切的前提是自动化。在Windows这个不体面的平台上，最大的困难应该是如何把所有手工操作都转化成脚本执行。如果这一步能够达成，再来考虑是到底是用<a href="http://www.opscode.com/chef">Chef</a>还是<a href="http://www.puppetlabs.com/">Puppet</a>之类的环境管理工具吧。